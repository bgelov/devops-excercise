## Тестовый деплой

- [https://prod-02.ip03.ru/php-service/](https://prod-02.ip03.ru/php-service/)
- https://prod-02.ip03.ru/nodejs-service/


## Запуск решения

Для простого запуска сценариев и деплоя я сделал разворачивание инфраструктуры с помощью Ansible через GitHub Actions.

Server_setup_workflow предназначен для первоначальной настройки сервера.
Необходимо запустить Workflow с параметрами:
- ip-адрес
- имя root пользователя

Так же в секреты репозитория необходимо добавить переменные: 
- TEMP_ROOT_PASSWORD - temp пароль root пользователя под которым будет выполняться первоначальная настройка
- ANSIBLE_PRIVATE_SSH_KEY - приватный ключ используемый ansible для подключения к хостам
- ANSIBLE_PUBLIC_SSH_KEY - публичный ключ для добавления к учётной записи на хост
- ANSIBLE_USERNAME - имя пользователя под которым будет работать ansoble на машине
- ANSIBLE_VAULT_PASSWORD - пароль для расшифровки vars.yml

```
Шифрование файла: ansible-vault encrypt vars.yml
Расшифровка: ansible-vault decrypt vars.yml
Редактирование: ansible-vault edit vars.yml
```

![image](https://github.com/bgelov/devops-excercise/assets/5302940/3a2980d9-79c7-4a2d-acdf-e4ecfdb99e3e)


Workflow Deploy разворачивает инфраструктуру на машины, согласно ролям из site.yml и машинам из inventory.yml.

## Процесс деплоя

Создаётся пустая машина с установленной Ubuntu и задаётся временный пароль пользователя root, который вносится в секрет TEMP_ROOT_PASSWORD.

![image](https://github.com/bgelov/devops-excercise/assets/5302940/32e5761d-4c3b-436d-ae36-1ff12f8a835c)


После этого запускаем Server_setup_workflow, который производит первоначальную настройку сервера, создаёт пользователя для дальнейшей работы, включает использование подключения по SSH, отключает вход по паролю, настраивает базово фаервол UFW и устанавливает базово необходимые пакеты. Здесь можно улучшать процесс бесконечно, в зависимости от требований ИБ конкретной компании.

Вносим информацию о хосте в файл ansible/inventory.yml и указываем необходимые роли для установки в файле ansible/site.yml.

Так как по условию все компоненты разворачиваются на один хост Ubuntu, указываем все роли:
- server-setup
- nodejs
- mysql
- php-fpm
- nginx
- haproxy

Далее запускаем workflow Deploy и происходит разворачивание перечисленных ролей.

server-setup устанавливает базовые пакеты и производит настройку фаервола, отключаем лишние сервисы и доступы.

nodejs устанавливает на машину NodeJS и копирует файлы приложения. Для того, чтобы решение соответствовало уровню производства, сервис nodejs запускается демоном под специально созданным для этого пользователем с ограниченными правами.

mysql разворачивается сервис MySQL, создаётся база данных и пользователь с предопределёнными заранее данными. Так же ограничиваем на доступ только с машины на которой развёрнут сервис.

php-fpm Разворачиваем php и php-fpm. Для того, чтобы решение соответствовало уровню проиводства, для php-приложения создаём отдельный пул с собственной конфигурацией.

nginx разворачивается nginx и добавляются ssl сертификаты. По условиям, именно на Nginx просходит терминация SSL и запросы к сервисам отправляются по http.

haproxy разворачивается в режиме tcp, на 4 уровне, т.к. по условиям терминацию SSL должен выполнять Nginx.

После выполнения деплоя сервисы доступны по адресам /nodejs-service и /php-service.


Процесс можно улучшить, например, добавив стадии тестирования, разворачивания на предрелизные сервера, добавив больше базовых настроек и настроек безопасности и т.д.


## Про масштабирование на несколько хостов
Чтобы масштабироваться и разделять решения на несколько хостов используем раздельные роли ansible и созданные workflow.

Первоначально на новой машине необходимо будет запустить роль первоначальной настройки с помощью Server_setup_workflow.

Далее добавить новый хост в ansible/inventory.yml и указать необходимые роли для данного хоста в site.yml.

В зависимости от сервиса, может потребоваться изменить конфигурации сервисов.

Конфигурации haproxy и nginx вынесены в отдельные директории services/nginx и services/haproxy.

Для деплоя необходимо будет запустить workflow Deploy.



## PHP-приложение и MySQL

Можно улучшить приложение для безопасного подключения к MySQL, например, используя переменные окружения ОС для хранения секретов. 

Добавить чтение переменных в код сервера через getenv():

```
$host = getenv('DB_HOST');
$dbname = getenv('DB_NAME');
$user = getenv('DB_USER');
$pass = getenv('DB_PASS');
```

И добавить определение этих переменных в переменные окружения ОС в роль mysql:

```
- name: Set MySQL Variables to OS
  lineinfile:
    path: /etc/environment
    line: "{{ item.name }}={{ item.value }}"
  loop:
    - { name: 'DB_HOST', value: '{{ db_host }}' }
    - { name: 'DB_NAME', value: '{{ db_name }}' }
    - { name: 'DB_USER', value: '{{ db_user }}' }
    - { name: 'DB_PASS', value: '{{ db_pass }}' }
```

Можно использовать .env файлы.

Можно использовать HashiCorp Vault, через подключение доп. библиотеки.


## Затраты по времени

- 2ч Анализ
- 2ч Тестирование
- 3ч Траблшутинг
- 6ч Разработка
- 2ч Документация
